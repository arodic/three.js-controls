<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js-controls</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				color: #fff;
				font-family:Monospace;
				text-align: center;
				font-size: 11px;
				line-height: 18px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 15px;
				z-index:100;
			}
			#info a {
				color: white;
				display: inline-block;
				text-decoration: none;
			}
			a::first-letter {
				color: #0f9;
				font-size: 15px;
				font-weight: bold;
				text-shadow: 1px 1px 2px black;
				letter-spacing: 0.1em;
			}
			canvas {
				width: 100% !important;
				height: 100% !important;
				image-rendering: pixelated;
			}
		</style>
	</head>
	<body>

		<div id="info">
			<span>Transform:</span>
			<a href="javascript:setupTransformControls('TransformControlsTranslate')">W translate</a> |
			<a href="javascript:setupTransformControls('TransformControlsRotate')">E rotate</a> |
			<a href="javascript:setupTransformControls('TransformControlsScale')">R scale</a> |
			<a href="javascript:setupTransformControls('TransformControlsStretch')">T freeScale (n/a) </a> |
			<a href="javascript:setupTransformControls('DragControls')">Y drag</a><br />
			<span>Viewport:</span>
			<a href="javascript:setupViewportControls('OrbitControls')">1 orbit</a> |
			<a href="javascript:setupViewportControls('EditorControls')">2 editor</a> |
			<a href="javascript:setupViewportControls('TrackballControls')">3 trackball</a><br />
			<!-- <a href="javascript:setupViewportControls('FirstPersonControls')">4 first person</a> | -->
			<!-- <a href="javascript:setupViewportControls('FlyControls')">3 fly</a><br /> -->
			<span>Toggle:</span>
			<a href="javascript:toggle('space')">Q space</a> |
			<a href="javascript:toggle('X')">X</a> |
			<a href="javascript:toggle('Y')">Y</a> |
			<a href="javascript:toggle('Z')">Z axis</a> |
			<span>Click select + Ctrl</span>
			<!-- <a>Shift marquee/add</a> | -->
			<!-- <a>Alt snap</a> -->
		</div>

		<script type="module">

			import {DragControls} from "./src/controls/DragControls.js";
			import {TransformControlsTranslate} from "./src/controls/TransformControlsTranslate.js";
			import {TransformControlsRotate} from "./src/controls/TransformControlsRotate.js";
			import {TransformControlsScale} from "./src/controls/TransformControlsScale.js";
			import {TransformControlsStretch} from "./src/controls/TransformControlsStretch.js";

			import {ViewportControls} from "./src/controls/ViewportControls.js";
			import {EditorControls} from "./src/controls/EditorControls.js";
			import {OrbitControls} from "./src/controls/OrbitControls.js";
			import {TrackballControls} from "./src/controls/TrackballControls.js";
			import {SelectionControls} from "./src/controls/SelectionControls.js";

			import {WebGLRenderer, PerspectiveCamera, Scene, GridHelper, DirectionalLight,
				BoxBufferGeometry, MeshLambertMaterial, Mesh, Object3D, TextureLoader, Color,
				SphereBufferGeometry, Vector3,BufferGeometry, BufferAttribute} from "./lib/three.module.js";

			let rendered = false;
			let renderer, camera, scene, helperScene;
			var transformControls, viewportControls;

			scene = new Scene();
			helperScene = new Scene();

			window.scale = 1;
			window.Vector3 = Vector3;

			init();
			render();

			function init() {

				renderer = new WebGLRenderer({ antialias: true });
				renderer.autoClear = false;

				let innerWidth = window.innerWidth / window.scale;
				let innerHeight = window.innerHeight / window.scale;

				renderer.setSize(innerWidth, innerHeight);
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setClearColor(0x666666);

				document.body.appendChild(renderer.domElement);

				var canvas = renderer.domElement;
				canvas.setAttribute('tabindex', 0);

				const bounds = canvas.getBoundingClientRect();
				canvas.width = Math.round(innerWidth * window.devicePixelRatio);
				canvas.height = Math.round(innerHeight * window.devicePixelRatio);

				camera = new PerspectiveCamera(50, innerWidth / innerHeight, 1, 300000);
				camera.position.set(1000, 500, 1000);
				camera.lookAt(0, 200, 0);

				var grid = new GridHelper(1000, 10);
				scene.add(grid);

				var light = new DirectionalLight(0x99ffff, 2);
				light.position.set(1, 0.5, 0.5);
				scene.add(light);

				var light = new DirectionalLight(0xff9999, 2);
				light.position.set(-0.5, 1, 0.2);
				scene.add(light);

				var light = new DirectionalLight(0x9999ff, 2);
				light.position.set(0.1, -0.3, -1);
				scene.add(light);

				let sphere = new Mesh(
					new SphereBufferGeometry(100, 24, 12),
					new MeshLambertMaterial({color: new Color(0.7,0.7,0.7), map: new TextureLoader().load( 'examples/textures/moon_1024.jpg', render )})
				);
				sphere.position.set(200, 300, -200);
				scene.add(sphere);

				sphere = new Mesh(
					new SphereBufferGeometry(10, 24, 12),
					new MeshLambertMaterial({color: new Color(0.7,0.7,0.7), map: new TextureLoader().load( 'examples/textures/moon_1024.jpg', render )})
				);
				sphere.position.set(-200, 300, 200);
				scene.add(sphere);

				var geometry = new BoxBufferGeometry(200, 200, 200);
				var material = new MeshLambertMaterial({map: new TextureLoader().load( 'examples/textures/crate.gif', render )});
				let box0 = new Mesh(geometry, material);
				box0.position.set(0,100,0);
				scene.add(box0);

				let box;
				let parent = box0;
				for (let i = 0; i < 2; i++) {
					box = new Mesh(geometry, material);
					box.position.set(0, 200, 0);
					box.rotation.set(0, -(i+1)/3, 0);
					parent.add(box);
					parent = box;
				}

				geometry = new BoxBufferGeometry(400, 400, 400);

				parent = box0;
				for (let i = 0; i < 2; i++) {
					box = new Mesh(geometry, material);
					if (i == 0) box.scale.set(0.5, 0.5, 0.5);
					box.position.set(0, 0, -200 / parent.scale.x);
					box.rotation.set(0, -Math.PI * (i + 1) / 2, 0);
					parent.add(box);
					parent = box;
				}
				parent = box0;

				geometry = new BoxBufferGeometry(100, 100, 100);

				for (let i = 0; i < 2; i++) {
					box = new Mesh(geometry, material);
					if (i == 0) box.scale.set(2, 2, 2);
					box.position.set(-200 / parent.scale.x, 0, 0);
					box.rotation.set(0, Math.PI * (i + 1) / 2, 0);
					parent.add(box);
					parent = box;
				}

				// for (var i = 0; i < 6; i++) {
				// 	for (var j = 0; j < 6; j++) {
				// 		for (var k = 0; k < 6; k++) {
				// 			const obj3d = new Object3D();
				// 			obj3d.position.set(i * 200 - 500, k * 200 - 500, j * 200 - 500);
				// 			helperScene.add(obj3d);
				// 			const control = new TransformHelperTranslate({domElement: canvas, camera: camera});
				// 			control.size = 0.1;
				// 			control.addEventListener('change', transformControlsChanged);
				// 			control.object = obj3d;
				// 			helperScene.add(control);
				// 		}
				// 	}
				// }

				var selectionControls = new SelectionControls({domElement: canvas, camera: camera, object_: scene});
				helperScene.add(selectionControls);
				selectionControls.addEventListener('change', render);
				selectionControls.addEventListener('selected-changed', event => {
					transformControls.object = event.selected.length ? selectionControls : null;
					transformControls.objectChanged();
				});

				setupViewportControls('OrbitControls');
				setupTransformControls('TransformControlsStretch');

				scene.updateMatrixWorld();
				selectionControls.replace([
					box0.children[1].children[0],
					box0.children[2].children[0],
				]);

				{
					let res = new Vector3(Math.round(window.innerWidth / window.scale), Math.round(window.innerHeight / window.scale), window.devicePixelRatio);
					helperScene.traverse(child => {
						if (child.material) child.material.resolution = res;
					})
				}

				function setupViewportControls(controlName) {
					let ControlClass = EditorControls;
					if (controlName === 'OrbitControls') ControlClass = OrbitControls;
					if (controlName === 'EditorControls') ControlClass = EditorControls;
					if (controlName === 'TrackballControls') ControlClass = TrackballControls;

					if (viewportControls) {
						viewportControls.dispose();
					}
					viewportControls = new ControlClass({domElement: canvas, camera: camera});
					viewportControls.addEventListener('change', viewportControlsChanged);
				}
				window.setupViewportControls = setupViewportControls;

				function viewportControlsChanged(event) {
					if (event.property === 'active') transformControls.enabled = event.value ? false : true && !!selectionControls.selected.length;
					render();
				}

				function setupTransformControls(controlName) {
					let ControlClass = TransformControlsTranslate;
					if (controlName === 'TransformControlsTranslate') ControlClass = TransformControlsTranslate;
					if (controlName === 'TransformControlsRotate') ControlClass = TransformControlsRotate;
					if (controlName === 'TransformControlsScale') ControlClass = TransformControlsScale;
					if (controlName === 'TransformControlsStretch') ControlClass = TransformControlsStretch;
					if (controlName === 'DragControls') ControlClass = DragControls;

					if (transformControls) {
						transformControls.dispose();
						helperScene.remove(transformControls);
					}
					if (selectionControls) selectionControls.enabled = true;
					if (viewportControls) viewportControls.enabled = true;
					transformControls = new ControlClass({domElement: canvas, camera: camera});
					transformControls.addEventListener('change', transformControlsChanged);
					transformControls.object = transformControls.object = selectionControls && selectionControls.selected.length ? selectionControls : null;
					transformControls.space = 'world';
					helperScene.add(transformControls);
				}
				window.setupTransformControls = setupTransformControls;

				function transformControlsChanged(event) {
					if (event.property === 'active') viewportControls.enabled = event.value ? false : true;
					if (event.property === 'space') selectionControls.transformSpace = event.value;
					if (event.property === 'axis') {
						selectionControls.enabled = event.value ? false : true;
						viewportControls.enabled = event.value ? false : true;
					}
					render();
				}

				function toggle(axis) {
					if (axis === "X") transformControls.showX = !transformControls.showX;
					if (axis === "Y") transformControls.showY = !transformControls.showY;
					if (axis === "Z") transformControls.showZ = !transformControls.showZ;
					if (axis === "space" && !transformControls.active) {
						transformControls.space = transformControls.space === "local" ? "world" : "local";
					}
				}
				window.toggle = toggle;

				window.addEventListener( 'keydown', function ( event ) {
					switch ( event.keyCode ) {
						case 87: // W
							setupTransformControls('TransformControlsTranslate');
							break;
						case 69: // E
							setupTransformControls('TransformControlsRotate');
							break;
						case 82: // R
							setupTransformControls('TransformControlsScale');
							break;
						case 84: // T
							setupTransformControls('TransformControlsStretch');
							break;
						case 89: // Y
							setupTransformControls('DragControls');
							break;
						case 49: // 1
							setupViewportControls('OrbitControls');
							break;
						case 50: // 2
							setupViewportControls('EditorControls');
							break;
						case 51: // 3
							setupViewportControls('TrackballControls');
							break;
						case 52: // 4
							// setupViewportControls(FirstPersonControls);
							break;
						case 53: // 5
							// setupViewportControls(FlyControls);
							break;
						case 81: // Q
							toggle('space');
							break;
						case 187:
						case 107: // +, =, num+
							transformControls.size = transformControls.size * 1.1;
							break;
						case 189:
						case 109: // -, _, num-
							transformControls.size = Math.max( transformControls.size * 0.9, 0.01 );
							break;
						case 88: // X
							toggle('X');
							break;
						case 89: // Y
							toggle('Y');
							break;
						case 90: // Z
							toggle('Z');
							break;
					}
				});
			}

			window.addEventListener('resize', onWindowResize, false);

			function onWindowResize() {

				camera.aspect = innerWidth / innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(innerWidth, innerHeight);

				render();

			}

			function animate() {

				requestAnimationFrame(animate);

				render();

			}


			function render() {
				if (rendered) return;
				rendered = true;

				renderer.clear();
				renderer.render(scene, camera);
				renderer.clearDepth();
				renderer.render(helperScene, camera);

				requestAnimationFrame(() => { rendered = false; })

			}

			render();

		</script>

	</body>
</html>
