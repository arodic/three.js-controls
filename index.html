<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js-controls</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				color: #fff;
				font-family:Monospace;
				text-align: center;
				font-size: 15px;
				line-height: 30px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 15px;
				z-index:100;
			}
			a {
				color: white;
			}
			canvas {
				width: 100% !important;
				height: 100% !important;
				image-rendering: pixelated;
			}
		</style>
	</head>
	<body>

		<div id="info">
			<a href="javascript:control.setMode( 'translate' );">"W" translate</a> |
			<a href="javascript:control.setMode( 'rotate' );">"E" rotate</a> |
			<a href="javascript:control.setMode( 'scale' );">"R" scale</a> |
			<a href="javascript:control.setSize( control.size + 0.1 );">"+" increase size</a> |
			<a href="javascript:control.setSize( Math.max( control.size - 0.1, 0.1 ) );">"-" decrease size</a><br />
			<a href="javascript:control.setSpace( control.space === 'local' ? 'world' : 'local' );">"Q" toggle world/local space</a> | Hold "Ctrl" down to snap to grid<br />
			<a href="javascript:control.showX = !control.showX">"X" toggle X</a> |
			<a href="javascript:control.showY = !control.showY">"Y" toggle Y</a> |
			<a href="javascript:control.showZ = !control.showZ">"Z" toggle Z</a> |
			<a href="javascript:control.enabled = !control.enabled">"Spacebar" toggle enabled</a><br />
		</div>

		<script type="module">

			import {TransformControlsTranslate} from "./src/controls/TransformControlsTranslate.js";
			import {TransformControlsRotate} from "./src/controls/TransformControlsRotate.js";
			import {TransformControlsScale} from "./src/controls/TransformControlsScale.js";
			import {TransformControlsFreescale} from "./src/controls/TransformControlsFreescale.js";

			import {ViewportControls} from "./src/controls/ViewportControls.js";
			import {EditorControls} from "./src/controls/EditorControls.js";
			import {OrbitControls} from "./src/controls/OrbitControls.js";
			import {TrackballControls} from "./src/controls/TrackballControls.js";
			import {SelectionControls} from "./src/controls/SelectionControls.js";

			import {TransformHelperTranslate} from "./src/helpers/TransformHelperTranslate.js";
			import {TransformHelperRotate} from "./src/helpers/TransformHelperRotate.js";
			import {TransformHelperScale} from "./src/helpers/TransformHelperScale.js";
			import {TransformHelperFreescale} from "./src/helpers/TransformHelperFreescale.js";
			import {HelperMesh} from "./src/helpers/HelperMesh.js";


			import {WebGLRenderer, PerspectiveCamera, Scene, GridHelper, DirectionalLight,
				BoxBufferGeometry, MeshLambertMaterial, Mesh,
				SphereBufferGeometry, Vector3,BufferGeometry, BufferAttribute} from "./lib/three.module.js";

			let rendered = false;
			let renderer, camera, scene, selection, helperScene;
			var transformControls;

			scene = new Scene();
			helperScene = new Scene();

			window.scale = 1;
			window.Vector3 = Vector3;

			init();
			render();

			function init() {

				renderer = new WebGLRenderer({ antialias: true });
				renderer.autoClear = false;

				let innerWidth = window.innerWidth / window.scale;
				let innerHeight = window.innerHeight / window.scale;

				renderer.setSize(innerWidth, innerHeight);
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setClearColor(0x666666);

				document.body.appendChild(renderer.domElement);

				var canvas = renderer.domElement;
				canvas.setAttribute('tabindex', 0);

				const bounds = canvas.getBoundingClientRect();
				canvas.width = Math.round(innerWidth * window.devicePixelRatio);
				canvas.height = Math.round(innerHeight * window.devicePixelRatio);

				camera = new PerspectiveCamera(50, innerWidth / innerHeight, 1, 300000);
				camera.position.set(1000, 500, 1000);
				camera.lookAt(0, 200, 0);

				var grid = new GridHelper(1000, 10);
				scene.add(grid);

				var light = new DirectionalLight(0x99ffff, 1);
				light.position.set(1, 0.5, 0.5);
				scene.add(light);

				var light = new DirectionalLight(0xff9999, 1);
				light.position.set(-0.5, 1, 0.2);
				scene.add(light);

				var light = new DirectionalLight(0x9999ff, 1);
				light.position.set(0.1, -0.3, -1);
				scene.add(light);

				var geometry = new BoxBufferGeometry(200, 200, 200);
				var material = new MeshLambertMaterial();

				let mesh0 = new Mesh(geometry, material);
				mesh0.position.set(0,0,0);
				scene.add(mesh0);

				let mesh;
				let patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(0, 200, 0);
					mesh.rotation.set(0, -(i+1)/3, 0);
					patent.add(mesh);
					patent = mesh;
				}
				patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(0, 0, -200);
					mesh.rotation.set(0, -Math.PI * (i + 1) / 2, 0);
					patent.add(mesh);
					patent = mesh;
				}patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(-200, 0, 0);
					mesh.rotation.set(0, Math.PI * (i + 1) / 2, 0);
					patent.add(mesh);
					patent = mesh;
				}

				for (var i = 0; i < 11; i++) {
					for (var j = 0; j < 11; j++) {
						// const helper = new TransformHelperRotate();
						// helper.size = 0;
						// helper.position.set(i * 100 - 500, 0, j * 100 - 500);
						// helper.scale.set(50,50,50);
						// helperScene.add(helper);
						//
						// const control = new TransformControlsTranslate({domElement: canvas, camera: camera});
						// control.object = helper;
						// helperScene.add(control);
					}
				}

				var selectionControls = new SelectionControls({domElement: canvas, camera: camera, scene: scene, selection: selection});
				helperScene.add(selectionControls);
				selectionControls.addEventListener('change', render);

				var viewportControls = new OrbitControls({domElement: canvas, camera: camera});
				// viewportControls.enableDamping = false;
				viewportControls.addEventListener('change', render);

				transformControls = new TransformControlsTranslate({domElement: canvas, camera: camera});
				transformControls.addEventListener('change', render);
				helperScene.add(transformControls);

				selectionControls.addEventListener('selected-changed', event => {
					transformControls.object = event.selected.length ? selectionControls : null;
				});

				scene.updateMatrixWorld();
				selectionControls.replace(mesh0);

				viewportControls.addEventListener('active-changed', event => {
					transformControls.enabled = event.value ? false : true && !!selectionControls.selected.length;
				});

				transformControls.addEventListener('active-changed', event => {
					viewportControls.enabled = event.value ? false : true;
				});
				transformControls.addEventListener('axis-changed', event => {
					selectionControls.enabled = event.value ? false : true;
					viewportControls.enabled = event.value ? false : true;
				});
				transformControls.addEventListener('space-changed', event => {
					selectionControls.transformSpace = event.value;
				});


				{
					let res = new Vector3(Math.round(window.innerWidth / window.scale), Math.round(window.innerHeight / window.scale), window.devicePixelRatio);
					helperScene.traverse(child => {
						if (child.material) child.material.resolution = res;
					})
				}

				render();

				// selectionControls.addEventListener('change', ()=>{ console.log('SelectionControls change'); } );
				// transformControls.addEventListener('change', ()=>{ console.log('TransformControls change'); } );
				// viewportControls.addEventListener('change', ()=>{ console.log('ViewportControls change'); } );
				// viewportControls.addEventListener('active-changed', event => {console.log('ViewportControls.active:', event.value);});
				// transformControls.addEventListener('axis-changed', event => {console.log('TransformControls.axis:', event.value);});
				// transformControls.addEventListener('active-changed', event => {console.log('TransformControls.active:', event.value);});
				// selection.addEventListener('selected-changed', event => {console.log('Selection.selected:', event.value);});

				window.addEventListener('resize', onWindowResize, false);

				window.addEventListener( 'keydown', function ( event ) {
					switch ( event.keyCode ) {

						case 81: // Q
							transformControls.space = transformControls.space === "local" ? "world" : "local";
							break;

						case 87: // W
							transformControls.dispose();
							helperScene.remove(transformControls);
							selectionControls.enabled = true;
							viewportControls.enabled = true;
							transformControls = new TransformControlsTranslate({domElement: canvas, camera: camera});
							transformControls.addEventListener('change', render);
							transformControls.object = selectionControls.selected.length ? selectionControls : null;
							transformControls.addEventListener('active-changed', event => {
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('axis-changed', event => {
								selectionControls.enabled = event.value ? false : true;
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('space-changed', event => {
								selectionControls.transformSpace = event.value;
							});
							helperScene.add(transformControls);
							break;

						case 69: // E
							transformControls.dispose();
							helperScene.remove(transformControls);
							selectionControls.enabled = true;
							viewportControls.enabled = true;
							transformControls = new TransformControlsRotate({domElement: canvas, camera: camera});
							transformControls.addEventListener('change', render);
							transformControls.object = selectionControls.selected.length ? selectionControls : null;
							transformControls.addEventListener('active-changed', event => {
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('axis-changed', event => {
								selectionControls.enabled = event.value ? false : true;
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('space-changed', event => {
								selectionControls.transformSpace = event.value;
							});
							helperScene.add(transformControls);
							break;

						case 82: // R
							transformControls.dispose();
							helperScene.remove(transformControls);
							selectionControls.enabled = true;
							viewportControls.enabled = true;
							transformControls = new TransformControlsScale({domElement: canvas, camera: camera});
							transformControls.addEventListener('change', render);
							transformControls.object = selectionControls.selected.length ? selectionControls : null;
							transformControls.addEventListener('active-changed', event => {
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('axis-changed', event => {
								selectionControls.enabled = event.value ? false : true;
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('space-changed', event => {
								selectionControls.transformSpace = event.value;
							});
							helperScene.add(transformControls);
							break;

						case 84: // T
							transformControls.dispose();
							helperScene.remove(transformControls);
							selectionControls.enabled = true;
							viewportControls.enabled = true;
							transformControls = new TransformControlsFreescale({domElement: canvas, camera: camera});
							transformControls.addEventListener('change', render);
							transformControls.object = selectionControls.selected.length ? selectionControls : null;
							transformControls.addEventListener('active-changed', event => {
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('axis-changed', event => {
								selectionControls.enabled = event.value ? false : true;
								viewportControls.enabled = event.value ? false : true;
							});
							transformControls.addEventListener('space-changed', event => {
								selectionControls.transformSpace = event.value;
							});
							helperScene.add(transformControls);
							break;

						case 187:
						case 107: // +, =, num+
							transformControls.size = transformControls.size + 0.1;
							break;

						case 189:
						case 109: // -, _, num-
							transformControls.size = Math.max( transformControls.size - 0.1, 0.1 );
							break;

						case 88: // X
							transformControls.showX = !transformControls.showX;
							break;

						case 89: // Y
							transformControls.showY = !transformControls.showY;
							break;

						case 90: // Z
							transformControls.showZ = !transformControls.showZ;
							break;

						case 32: // Spacebar
							transformControls.enabled = !transformControls.enabled;

							break;

					}

				});

				window.addEventListener( 'keyup', function ( event ) {

					switch ( event.keyCode ) {

						case 17: // Ctrl
							transformControls.translationSnap = null;
							transformControls.rotationSnap = null;
							break;

					}

				});
			}

			function onWindowResize() {

				camera.aspect = innerWidth / innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(innerWidth, innerHeight);

				render();

			}


			function render() {
				if (rendered) return;
				rendered = true;

				renderer.clear();
				renderer.render(scene, camera);
				renderer.clearDepth();
				renderer.render(helperScene, camera);

				requestAnimationFrame(() => { rendered = false; })

			}

		</script>

	</body>
</html>
