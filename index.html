<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js-controls</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				color: #fff;
				font-family:Monospace;
				text-align: center;
				font-size: 15px;
				line-height: 30px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 15px;
				z-index:100;
			}
			a {
				color: white;
			}
		</style>
	</head>
	<body>

		<div id="info">
			<a href="javascript:control.setMode( 'translate' );">"W" translate</a> |
			<a href="javascript:control.setMode( 'rotate' );">"E" rotate</a> |
			<a href="javascript:control.setMode( 'scale' );">"R" scale</a> |
			<a href="javascript:control.setSize( control.size + 0.1 );">"+" increase size</a> |
			<a href="javascript:control.setSize( Math.max( control.size - 0.1, 0.1 ) );">"-" decrease size</a><br />
			<a href="javascript:control.setSpace( control.space === 'local' ? 'world' : 'local' );">"Q" toggle world/local space</a> | Hold "Ctrl" down to snap to grid<br />
			<a href="javascript:control.showX = !control.showX">"X" toggle X</a> |
			<a href="javascript:control.showY = !control.showY">"Y" toggle Y</a> |
			<a href="javascript:control.showZ = !control.showZ">"Z" toggle Z</a> |
			<a href="javascript:control.enabled = !control.enabled">"Spacebar" toggle enabled</a><br />
		</div>

		<script type="module">

			import {TransformControls} from "./src/controls/TransformControls.js";

			import {ViewportControls} from "./src/controls/ViewportControls.js";
			import {EditorControls} from "./src/controls/EditorControls.js";
			import {OrbitControls} from "./src/controls/OrbitControls.js";
			import {TrackballControls} from "./src/controls/TrackballControls.js";
			import {SelectionControls} from "./src/controls/SelectionControls.js";

			import {Selection} from "./src/Selection.js";

			import {AxesHelper} from "./src/helpers/AxesHelper.js";


			import {WebGLRenderer, Math, PerspectiveCamera, Scene, GridHelper, DirectionalLight, TextureLoader, BoxBufferGeometry, MeshLambertMaterial, Mesh, BoxHelper} from "../../three.js/build/three.module.js";

			let renderer, camera, scene, selection, helperScene;

			init();
			render();

			function init() {

				renderer = new WebGLRenderer({ antialias: false });

				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.setPixelRatio(window.devicePixelRatio);

				document.body.appendChild(renderer.domElement);

				var canvas = renderer.domElement;
				canvas.setAttribute('tabindex', 0);

				const bounds = canvas.getBoundingClientRect();
				canvas.width = window.Math.round(bounds.width * window.devicePixelRatio);
				canvas.height = window.Math.round(bounds.height * window.devicePixelRatio);

				camera = new PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 3000000);
				camera.position.set(1000, 500, 1000);
				camera.lookAt(0, 200, 0);

				scene = new Scene();
				helperScene = new Scene();

				var grid = new GridHelper(1000, 10);
				helperScene.add(grid);

				var light = new DirectionalLight(0x99ffff, 2);
				light.position.set(1, 0.5, 0.5);
				scene.add(light);

				var light = new DirectionalLight(0xff9999, 2);
				light.position.set(-0.5, 1, 0.2);
				scene.add(light);

				var light = new DirectionalLight(0x9999ff, 2);
				light.position.set(0.1, -0.3, -1);
				scene.add(light);

				var texture = new TextureLoader().load('../../three.js/examples/textures/crate.gif', render);
				texture.anisotropy = renderer.capabilities.getMaxAnisotropy();

				var geometry = new BoxBufferGeometry(200, 200, 200);
				var material = new MeshLambertMaterial({ map: texture });

				let mesh0 = new Mesh(geometry, material);
				mesh0.position.set(0,0,0);
				scene.add(mesh0);

				let mesh;
				let patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(0, 200, 0);
					mesh.rotation.set(0, -(i+1)/3, 0);
					patent.add(mesh);
					patent = mesh;
				}
				patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(0, 0, -200);
					mesh.rotation.set(0, -window.Math.PI * (i + 1) / 2, 0);
					patent.add(mesh);
					patent = mesh;
				}patent = mesh0;
				for (let i = 0; i < 2; i++) {
					mesh = new Mesh(geometry, material);
					mesh.position.set(-200, 0, 0);
					mesh.rotation.set(0, window.Math.PI * (i + 1) / 2, 0);
					patent.add(mesh);
					patent = mesh;
				}

				selection = new Selection({transformSpace: 'world'});
				helperScene.add(selection);

				selection.addEventListener('change', render);
				selection.addEventListener('selected-changed', event => {
					transformControls.object = event.selected.length ? selection : null;
				})

				var selectionControls = new SelectionControls(camera, renderer.domElement, scene, selection);

				var viewportControls = new OrbitControls(camera, renderer.domElement);
				viewportControls.addEventListener('change', render);

				var transformControls = new TransformControls(camera, renderer.domElement);
				transformControls.addEventListener('change', render);
				transformControls.addEventListener('space-changed', event => { selection.transformSpace = event.value; });
				helperScene.add(transformControls);

				viewportControls.addEventListener('active-changed', event => {
					// transformControls.enabled = !event.value && !!selection.selected.length;
				});

				transformControls.addEventListener('active-changed', event => {
					viewportControls.enabled = !event.value;
				});
				transformControls.addEventListener('axis-changed', event => {
					selectionControls.enabled = !event.value;
				});

				// selection.addEventListener('change', ()=>{ console.log('Selection change'); } );
				// selectionControls.addEventListener('change', ()=>{ console.log('SelectionControls change'); } );
				// transformControls.addEventListener('change', ()=>{ console.log('TransformControls change'); } );
				// viewportControls.addEventListener('change', ()=>{ console.log('ViewportControls change'); } );
				// viewportControls.addEventListener('active-changed', event => {console.log('ViewportControls.active:', event.value);});
				// transformControls.addEventListener('axis-changed', event => {console.log('TransformControls.axis:', event.value);});
				// transformControls.addEventListener('active-changed', event => {console.log('TransformControls.active:', event.value);});
				// selection.addEventListener('selected-changed', event => {console.log('Selection.selected:', event.value);});

				window.addEventListener('resize', onWindowResize, false);

				window.addEventListener( 'keydown', function ( event ) {

					switch ( event.keyCode ) {

						case 81: // Q
							transformControls.space = transformControls.space === "local" ? "world" : "local";
							break;

						case 17: // Ctrl
							transformControls.translationSnap = 100;
							transformControls.rotationSnap = Math.degToRad( 15 );
							break;

						case 87: // W
							transformControls.mode = "translate";
							break;

						case 69: // E
							transformControls.mode = "rotate";
							break;

						case 82: // R
							transformControls.mode = "scale";
							break;

						case 187:
						case 107: // +, =, num+
							transformControls.size = transformControls.size + 0.1;
							break;

						case 189:
						case 109: // -, _, num-
							transformControls.size = Math.max( transformControls.size - 0.1, 0.1 );
							break;

						case 88: // X
							transformControls.showX = !transformControls.showX;
							break;

						case 89: // Y
							transformControls.showY = !transformControls.showY;
							break;

						case 90: // Z
							transformControls.showZ = !transformControls.showZ;
							break;

						case 32: // Spacebar
							transformControls.enabled = !transformControls.enabled;
							break;

					}

				});

				window.addEventListener( 'keyup', function ( event ) {

					switch ( event.keyCode ) {

						case 17: // Ctrl
							transformControls.translationSnap = null;
							transformControls.rotationSnap = null;
							break;

					}

				});
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);

				render();

			}

			function render() {
				helperScene.traverse(object => {
					object.camera = camera;
				});

				renderer.clear();
				renderer.autoClear = false;
				renderer.render(scene, camera);
				renderer.render(helperScene, camera);

			}

		</script>

	</body>
</html>
